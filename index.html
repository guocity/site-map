<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resource Browser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: {
                            bg: '#0f172a',      // Slate 900
                            panel: '#1e293b',   // Slate 800
                            border: '#334155',  // Slate 700
                            hover: '#334155',   // Slate 700
                            text: '#e2e8f0',    // Slate 200
                            muted: '#94a3b8',   // Slate 400
                            blue: '#3b82f6',
                        }
                    },
                    fontSize: {
                        'xxs': '0.65rem',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #0f172a;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background-color: #475569;
        }

        /* Smooth Toggle Icon Rotation */
        .toggle-icon {
            transition: transform 0.15s ease;
        }
        .toggle-icon.expanded {
            transform: rotate(90deg);
        }

        .sidebar-transition {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .noselect {
            user-select: none;
        }
        
        /* Material Icons adjustment */
        .material-icons {
            font-size: 16px;
            line-height: 1;
        }
        /* Specific size for control buttons to match compact grid */
        .control-icon {
            font-size: 18px; 
        }
    </style>
</head>
<body class="bg-dark-bg text-dark-text h-screen flex flex-col md:flex-row overflow-hidden font-sans text-sm">

    <!-- Mobile Header -->
    <header class="md:hidden bg-dark-panel border-b border-dark-border h-12 flex items-center justify-between px-3 z-20 shrink-0">
        <div class="flex items-center">
            <button id="mobile-menu-btn" class="p-1.5 -ml-1 rounded hover:bg-dark-hover text-dark-muted">
                <span class="material-icons">menu</span>
            </button>
            <h1 class="font-semibold text-sm ml-2 text-dark-text">Resource Browser</h1>
        </div>
    </header>

    <!-- Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden opacity-0 transition-opacity duration-200"></div>

    <!-- Left Sidebar (Scroll Independent) -->
    <aside id="sidebar" class="sidebar-transition fixed inset-y-0 left-0 z-40 w-64 bg-dark-panel border-r border-dark-border transform -translate-x-full md:relative md:translate-x-0 flex flex-col shadow-xl md:shadow-none shrink-0">
        
        <!-- Sidebar Header -->
        <div class="h-10 flex items-center justify-between px-3 border-b border-dark-border shrink-0 bg-dark-panel">
            <h2 class="font-bold text-dark-muted text-xs uppercase tracking-wider flex items-center gap-2">
                <span class="material-icons text-blue-500" style="font-size: 18px;">folder_open</span>
                Explorer
            </h2>
            <button id="sidebar-close-btn" class="md:hidden text-dark-muted">
                <span class="material-icons">close</span>
            </button>
        </div>

        <!-- Sidebar Content -->
        <div class="flex-1 overflow-y-auto p-3 custom-scroll space-y-5">
            
            <!-- Compact Controls Grid -->
            <div class="space-y-2">
                <div class="flex items-center justify-between px-1">
                    <label class="text-[10px] font-bold text-dark-muted uppercase tracking-wider">Actions</label>
                    <span id="mode-indicator" class="text-blue-500 font-bold font-mono text-[10px]">URL</span>
                </div>
                
                <div class="grid grid-cols-5 gap-1">
                    <button id="expand-all-btn" class="bg-dark-bg border border-dark-border hover:bg-dark-hover text-dark-muted hover:text-dark-text py-1.5 rounded transition-colors flex justify-center items-center group" title="Expand All">
                        <span class="material-icons control-icon">unfold_more</span>
                    </button>
                    <button id="collapse-all-btn" class="bg-dark-bg border border-dark-border hover:bg-dark-hover text-dark-muted hover:text-dark-text py-1.5 rounded transition-colors flex justify-center items-center group" title="Collapse All">
                        <span class="material-icons control-icon">unfold_less</span>
                    </button>
                    <button id="level-minus-btn" class="bg-dark-bg border border-dark-border hover:bg-dark-hover text-dark-muted hover:text-dark-text py-1.5 rounded transition-colors flex justify-center items-center group" title="Close 1 Level">
                        <span class="material-icons control-icon">remove</span>
                    </button>
                    <button id="level-plus-btn" class="bg-dark-bg border border-dark-border hover:bg-dark-hover text-dark-muted hover:text-dark-text py-1.5 rounded transition-colors flex justify-center items-center group" title="Open 1 Level">
                        <span class="material-icons control-icon">add</span>
                    </button>
                    <button id="toggle-view-btn" class="bg-dark-bg border border-dark-border hover:bg-dark-hover text-dark-muted hover:text-dark-text py-1.5 rounded transition-colors flex justify-center items-center group" title="Toggle View (URL/Title)">
                        <span class="material-icons control-icon">subtitles</span>
                    </button>
                </div>
            </div>

            <!-- Data Source -->
            <div class="space-y-1.5">
                <label class="text-[10px] font-bold text-dark-muted uppercase tracking-wider">Source</label>
                <div id="source-list" class="space-y-1">
                </div>
            </div>

            <div class="text-[10px] text-dark-muted pt-4 border-t border-dark-border">
                <p>Load a source to begin.</p>
            </div>
        </div>

        <!-- Sidebar Footer -->
        <div class="p-2 border-t border-dark-border text-[10px] text-center text-dark-muted bg-dark-panel">
            <span class="opacity-50">v2.3 Compact Controls</span>
        </div>
    </aside>

    <!-- Main Content (Scroll Independent) -->
    <main class="flex-1 h-full overflow-hidden flex flex-col relative bg-dark-bg">
        
        <!-- Desktop Toolbar -->
        <div class="hidden md:flex h-10 bg-dark-panel border-b border-dark-border items-center justify-between px-4 shrink-0 sticky top-0 z-10">
            <div class="flex items-center gap-2">
                 <span class="material-icons text-dark-muted" style="font-size: 16px;">dns</span>
                <h2 id="main-title" class="text-xs font-semibold text-dark-text font-mono">/</h2>
            </div>
            <div class="flex items-center gap-2">
                <span id="total-links-count" class="text-xs font-mono text-dark-muted mr-4"></span>
                <span id="loading-indicator" class="hidden flex items-center text-[10px] text-dark-muted animate-pulse">
                    LOADING...
                </span>
            </div>
        </div>

        <!-- Stats Panel (Top of Main, Hidden by Default) -->
        <div id="stats-panel" class="hidden bg-dark-bg border-b border-dark-border px-4 py-2 shrink-0">
             <!-- Stats injected here -->
        </div>

        <!-- Tree Area -->
        <div class="flex-1 overflow-y-auto custom-scroll p-2 md:p-3">
            <div id="tree-container" class="max-w-full pb-20">
                <!-- Empty State -->
                <div class="flex flex-col items-center justify-center h-64 text-dark-muted text-center border-2 border-dashed border-dark-border rounded-lg m-4">
                    <span class="material-icons text-dark-border mb-2" style="font-size: 48px;">account_tree</span>
                    <p class="text-xs">Select a source to inspect.</p>
                    <button id="load-dummy-btn" class="mt-3 text-blue-500 hover:text-blue-400 text-xs font-mono">Load Demo Data</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        /**
         * APP LOGIC - Ultra Compact Dark Edition with Level Controls
         */

        // --- MOCK DATA ---
        const MOCK_DATA = [
            // Core
            ["https://sys.local/api", "API Root", 200],
            ["https://sys.local/api/v1/health", "Health Check", 200],
            ["https://sys.local/api/v1/auth", "Auth Service", 403],
            // Assets
            ["https://sys.local/assets/css/main.css", "Stylesheet", 200],
            ["https://sys.local/assets/js/app.bundle.js", "Bundle", 200],
            ["https://sys.local/assets/img/logo.png", "Logo", 200],
            ["https://sys.local/assets/img/hero.jpg", "Hero", 404],
            ["https://sys.local/assets/img/icons/favicon.ico", "Icon", 200],
            // Admin
            ["https://sys.local/admin", "Admin Panel", 302],
            ["https://sys.local/admin/login", "Admin Login", 200],
            ["https://sys.local/admin/users", "User Management", 500],
            ["https://sys.local/admin/users/details/1", "User 1", 200],
            ["https://sys.local/admin/users/details/2", "User 2", 200],
            ["https://sys.local/admin/settings", "Settings", 200],
            // Errors for stats
            ["https://sys.local/weird/endpoint", "Legacy", 410],
            ["https://sys.local/test/error", "Test Error", 503],
            ["https://sys.local/test/badrequest", "Bad Req", 400],
        ];

        const App = {
            config: { manifestPath: 'manifest.json', jsonPrefix: 'json/' },
            state: { 
                treeData: null, 
                displayMode: 'url', 
                isLoading: false,
                currentDepth: 1 // Tracks the global depth setting
            },
            actions: {}
        };

        const DOM = {
            container: document.getElementById('tree-container'),
            sourceList: document.getElementById('source-list'),
            countDisplay: document.getElementById('total-links-count'),
            statsPanel: document.getElementById('stats-panel'),
            modeIndicator: document.getElementById('mode-indicator'),
            loading: document.getElementById('loading-indicator'),
            title: document.getElementById('main-title'),
            sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('sidebar-overlay')
        };

        // --- STATS LOGIC ---
        function calculateAndRenderStats(dataArray) {
            const stats = {
                '2xx': { count: 0, color: 'bg-emerald-500', text: 'text-emerald-500', label: 'OK' },
                '3xx': { count: 0, color: 'bg-amber-500', text: 'text-amber-500', label: 'Redir' },
                '4xx': { count: 0, color: 'bg-red-500', text: 'text-red-500', label: 'Cl.Err' },
                '5xx': { count: 0, color: 'bg-rose-600', text: 'text-rose-600', label: 'Sv.Err' },
                'Other': { count: 0, color: 'bg-slate-500', text: 'text-slate-500', label: 'Unk' }
            };

            let total = 0;

            dataArray.forEach(item => {
                let status = 0;
                if (Array.isArray(item) && item.length >= 3) status = parseInt(item[2]);
                else if (typeof item === 'object' && item.status) status = parseInt(item.status);

                if (status) {
                    total++;
                    if (status >= 200 && status < 300) stats['2xx'].count++;
                    else if (status >= 300 && status < 400) stats['3xx'].count++;
                    else if (status >= 400 && status < 500) stats['4xx'].count++;
                    else if (status >= 500 && status < 600) stats['5xx'].count++;
                    else stats['Other'].count++;
                }
            });

            if (total > 0) {
                let html = `<div class="flex flex-col gap-1">`;
                html += `<div class="flex w-full h-2 bg-dark-panel rounded-full overflow-hidden">`;
                Object.keys(stats).forEach(key => {
                    const group = stats[key];
                    if (group.count > 0) {
                        const percent = ((group.count / total) * 100);
                        html += `<div class="${group.color}" style="width: ${percent}%" title="${key}: ${group.count}"></div>`;
                    }
                });
                html += `</div>`;
                html += `<div class="flex gap-4 text-[10px] font-mono">`;
                Object.keys(stats).forEach(key => {
                    const group = stats[key];
                    if (group.count > 0) {
                        const percent = ((group.count / total) * 100).toFixed(0);
                        html += `<div class="flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full ${group.color}"></span>
                            <span class="text-dark-muted">${key}</span>
                            <span class="${group.text} font-bold">${group.count}</span>
                            <span class="text-dark-border opacity-50">${percent}%</span>
                        </div>`;
                    }
                });
                html += `</div></div>`;
                DOM.statsPanel.innerHTML = html;
                DOM.statsPanel.classList.remove('hidden');
            } else {
                DOM.statsPanel.classList.add('hidden');
            }
        }

        // --- TREE BUILDING & RECURSIVE COUNTS ---
        function buildTree(dataArray) {
            const hosts = {};
            let totalLinks = 0;

            if (!Array.isArray(dataArray)) return { tree: {}, count: 0 };

            dataArray.forEach(item => {
                let originalUrl, title, status;
                if (Array.isArray(item) && item.length >= 3) {
                    [originalUrl, title, status] = item;
                } else if (typeof item === 'object' && item.url) {
                    originalUrl = item.url; title = item.title; status = item.status;
                } else return;

                totalLinks++;

                try {
                    const urlObj = new URL(originalUrl);
                    const hostname = urlObj.hostname;
                    let pathname = urlObj.pathname;
                    const search = urlObj.search;

                    if (!hosts[hostname]) {
                        hosts[hostname] = { type: 'host', name: hostname, children: {}, count: 0, isCollapsed: false, leafCount: 0 };
                    }
                    hosts[hostname].count++;

                    if (pathname.startsWith('/')) pathname = pathname.substring(1);
                    if (pathname.endsWith('/')) pathname = pathname.slice(0, -1);

                    let currentNode = hosts[hostname];

                    // Root handling
                    if (pathname === '' && search === '') {
                        currentNode.isEndpoint = true;
                        currentNode.data = { url: originalUrl, title, status };
                        return;
                    }

                    const segments = pathname.split('/').filter(s => s !== '');
                    if (search) {
                        if (segments.length === 0) segments.push(search);
                        else segments[segments.length - 1] += search;
                    }

                    segments.forEach((segment, index) => {
                        if (!currentNode.children[segment]) {
                            currentNode.children[segment] = {
                                type: 'folder',
                                name: segment,
                                children: {},
                                isCollapsed: false, // Will be reset by depth logic
                                isEndpoint: false,
                                leafCount: 0
                            };
                        }
                        currentNode = currentNode.children[segment];
                        if (index === segments.length - 1) {
                            currentNode.isEndpoint = true;
                            currentNode.data = { url: originalUrl, title, status };
                        }
                    });
                } catch (e) { }
            });

            // Post-process to calculate total leaf counts recursively
            Object.values(hosts).forEach(host => calculateLeafCounts(host));

            return { tree: hosts, count: totalLinks };
        }

        function calculateLeafCounts(node) {
            let count = 0;
            // If this node itself is an endpoint (not just a folder), count it
            if (node.isEndpoint) count = 1;

            // Add counts from all children
            if (node.children) {
                Object.values(node.children).forEach(child => {
                    count += calculateLeafCounts(child);
                });
            }
            node.leafCount = count;
            return count;
        }

        // --- DEPTH CONTROL ---
        function setCollapseStateByDepth(node, currentDepth, targetDepth) {
            // If current depth is less than target, it should be open (isCollapsed = false)
            // If current depth is >= target, it should be closed (isCollapsed = true)
            if (currentDepth < targetDepth) {
                node.isCollapsed = false;
            } else {
                node.isCollapsed = true;
            }

            if (node.children) {
                Object.values(node.children).forEach(child => 
                    setCollapseStateByDepth(child, currentDepth + 1, targetDepth)
                );
            }
        }

        App.actions.changeDepth = (increment) => {
            if (!App.state.treeData) return;
            
            App.state.currentDepth += increment;
            if (App.state.currentDepth < 1) App.state.currentDepth = 1;

            Object.values(App.state.treeData).forEach(host => 
                setCollapseStateByDepth(host, 0, App.state.currentDepth)
            );
            refreshTree();
        };


        function setCollapseStateRecursive(node, isCollapsed) {
            node.isCollapsed = isCollapsed;
            if (node.children) Object.values(node.children).forEach(child => setCollapseStateRecursive(child, isCollapsed));
        }

        // --- RENDERING (Adjusted Indent) ---
        function renderStatusBadge(status) {
            const code = parseInt(status);
            let colorClass = 'text-dark-muted border-dark-border';
            let label = status;

            if (code >= 200 && code < 300) colorClass = 'text-emerald-400 border-emerald-400/30 bg-emerald-400/10';
            else if (code >= 300 && code < 400) colorClass = 'text-amber-400 border-amber-400/30 bg-amber-400/10';
            else if (code >= 400 && code < 500) colorClass = 'text-red-400 border-red-400/30 bg-red-400/10';
            else if (code >= 500) colorClass = 'text-rose-500 border-rose-500/30 bg-rose-500/10';

            return `<span class="inline-flex items-center px-1 rounded-[2px] text-[9px] font-mono border ${colorClass} ml-1.5 min-w-[2rem] justify-center leading-3 h-3.5">${label}</span>`;
        }

        function renderNode(node, level = 0) {
            const hasChildren = node.children && Object.keys(node.children).length > 0;
            
            // Reduced indent multiplier (0.35rem per level instead of 0.75rem)
            const paddingLeft = level * 0.35; 

            let displayName = node.name;
            if (App.state.displayMode === 'title' && node.data && node.data.title) displayName = node.data.title;
            else if (node.type === 'host') displayName = node.name;

            const containerClass = `group relative`;
            const hostClass = `flex items-center py-0.5 px-1 border-l-2 border-transparent hover:bg-dark-hover/50 cursor-pointer transition-colors`;
            const itemClass = `flex items-center py-0.5 pr-1 hover:bg-dark-hover/50 cursor-pointer select-none transition-colors`;
            const rowClass = node.type === 'host' ? hostClass : itemClass;
            
            const textClass = node.type === 'host' 
                ? `font-semibold text-xs text-dark-text ml-1` 
                : `font-mono text-xs ml-1 truncate ${node.isEndpoint ? 'text-blue-400' : 'text-dark-muted'}`;

            const div = document.createElement('div');
            div.className = containerClass;

            const header = document.createElement('div');
            header.className = rowClass;
            if (node.type !== 'host') header.style.paddingLeft = `${paddingLeft}rem`;
            if (node.type === 'host') header.style.backgroundColor = '#172033';

            const toggleHtml = hasChildren 
                ? `<span class="material-icons text-dark-muted toggle-icon ${!node.isCollapsed ? 'expanded' : ''}" style="font-size: 12px;">play_arrow</span>`
                : `<span style="width: 12px; display: inline-block;"></span>`;

            let iconHtml = '';
            if (node.type === 'host') iconHtml = ``; 
            else if (hasChildren) iconHtml = `<span class="material-icons text-yellow-600/80 mr-1" style="font-size: 12px;">folder</span>`;
            else iconHtml = `<span class="text-dark-border mr-1 opacity-50 text-[10px]">-</span>`;

            header.innerHTML = `${toggleHtml}${iconHtml}<span class="${textClass}">${displayName}</span>`;

            // Counts: Show leaf count for Hosts AND Folders
            if (node.leafCount > 0) {
                header.innerHTML += `<span class="text-[9px] text-dark-muted font-mono px-1 ml-2 opacity-75">[${node.leafCount}]</span>`;
            }

            if (node.isEndpoint && node.data) {
                header.innerHTML += renderStatusBadge(node.data.status);
                header.innerHTML += `<a href="${node.data.url}" target="_blank" class="ml-auto opacity-0 group-hover:opacity-100 p-0.5 text-dark-muted hover:text-blue-400 transition-all"><span class="material-icons" style="font-size: 12px;">open_in_new</span></a>`;
            }

            header.addEventListener('click', () => {
                if (hasChildren) {
                    node.isCollapsed = !node.isCollapsed;
                    refreshTree();
                }
            });

            div.appendChild(header);

            if (hasChildren && !node.isCollapsed) {
                const childrenContainer = document.createElement('div');
                // Adjusted guide line indent to match new padding
                if (node.type !== 'host') {
                    childrenContainer.className = 'relative ml-[0.3rem] pl-[0.3rem] border-l border-dark-border/40';
                } else {
                    childrenContainer.className = 'mt-0.5';
                }

                const sortedKeys = Object.keys(node.children).sort((a, b) => {
                    const childA = node.children[a], childB = node.children[b];
                    const aKids = Object.keys(childA.children).length > 0;
                    const bKids = Object.keys(childB.children).length > 0;
                    if (aKids && !bKids) return -1;
                    if (!aKids && bKids) return 1;
                    return a.localeCompare(b);
                });

                sortedKeys.forEach(key => {
                    childrenContainer.appendChild(renderNode(node.children[key], node.type === 'host' ? 0.5 : level + 1));
                });
                div.appendChild(childrenContainer);
            }
            return div;
        }

        function refreshTree() {
            if (!App.state.treeData) return;
            DOM.container.innerHTML = '';
            Object.keys(App.state.treeData)
                .sort((a, b) => App.state.treeData[b].leafCount - App.state.treeData[a].leafCount)
                .forEach(host => DOM.container.appendChild(renderNode(App.state.treeData[host])));
        }

        // --- INIT & EVENTS ---
        async function loadManifest() {
            try {
                const res = await fetch(App.config.manifestPath);
                if (!res.ok) throw new Error();
                const files = await res.json();
                DOM.sourceList.innerHTML = '';

                files.forEach(f => {
                    if(f.endsWith('.json')) {
                        const div = document.createElement('div');
                        div.className = 'text-dark-text py-0.5 px-1 text-xs cursor-pointer hover:text-blue-400 transition-colors';
                        div.textContent = f.replace('.json', '');
                        div.dataset.value = App.config.jsonPrefix + f;
                        DOM.sourceList.appendChild(div);
                    }
                });
            } catch (e) {
                DOM.sourceList.innerHTML = '<div class="text-dark-text py-0.5 px-1 text-xs cursor-pointer hover:text-blue-400 transition-colors" data-value="dummy">âš¡ Demo Data (Offline)</div>';
                loadData('dummy');
            }
        }

        async function loadData(source) {
            DOM.loading.classList.remove('hidden');
            DOM.container.innerHTML = '';
            DOM.countDisplay.textContent = '...';
            DOM.statsPanel.innerHTML = ''; 
            DOM.statsPanel.classList.add('hidden');

            let data = [];
            try {
                if (source === 'dummy') {
                    await new Promise(r => setTimeout(r, 300));
                    data = MOCK_DATA;
                } else {
                    const res = await fetch(source);
                    if (!res.ok) throw new Error();
                    data = await res.json();
                }

                const { tree, count } = buildTree(data);
                App.state.treeData = tree;
                DOM.countDisplay.textContent = `${count} Links`;
                DOM.title.textContent = source === 'dummy' ? 'DEMO_DATA' : source.split('/').pop();
                
                calculateAndRenderStats(data);
                
                // Reset Depth
                App.state.currentDepth = 1;
                Object.values(App.state.treeData).forEach(host => 
                    setCollapseStateByDepth(host, 0, 1)
                );
                refreshTree();

            } catch (e) {
                console.error(e);
                DOM.container.innerHTML = `<div class="text-red-400 text-center p-4 text-xs border border-red-900 bg-red-900/20 rounded">Failed to load data.</div>`;
            } finally {
                DOM.loading.classList.add('hidden');
                if (window.innerWidth < 768) toggleSidebar(false);
            }
        }

        // Sidebar Toggles
        const toggleSidebar = (show) => {
            const isHidden = DOM.sidebar.classList.contains('-translate-x-full');
            if (show !== undefined ? show : isHidden) {
                DOM.sidebar.classList.remove('-translate-x-full');
                DOM.overlay.classList.remove('hidden');
                setTimeout(() => DOM.overlay.classList.remove('opacity-0'), 10);
            } else {
                DOM.sidebar.classList.add('-translate-x-full');
                DOM.overlay.classList.add('opacity-0');
                setTimeout(() => DOM.overlay.classList.add('hidden'), 200);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadManifest();
            DOM.sourceList.addEventListener('click', (e) => {
                if (e.target.dataset.value) {
                    loadData(e.target.dataset.value);
                }
            });
            document.getElementById('load-dummy-btn')?.addEventListener('click', () => loadData('dummy'));
            
            document.getElementById('expand-all-btn').addEventListener('click', () => { 
                if(App.state.treeData) { 
                    App.state.currentDepth = 999; // Set max depth
                    Object.values(App.state.treeData).forEach(h => setCollapseStateRecursive(h, false)); 
                    refreshTree(); 
                }
            });
            
            document.getElementById('collapse-all-btn').addEventListener('click', () => { 
                if(App.state.treeData) { 
                    App.state.currentDepth = 0; // Reset depth
                    Object.values(App.state.treeData).forEach(h => setCollapseStateRecursive(h, true)); 
                    refreshTree(); 
                }
            });
            
            // Level Controls
            document.getElementById('level-plus-btn').addEventListener('click', () => App.actions.changeDepth(1));
            document.getElementById('level-minus-btn').addEventListener('click', () => App.actions.changeDepth(-1));

            document.getElementById('toggle-view-btn').addEventListener('click', () => { 
                App.state.displayMode = App.state.displayMode === 'url' ? 'title' : 'url'; 
                DOM.modeIndicator.textContent = App.state.displayMode === 'url' ? 'URL' : 'TITLE'; 
                refreshTree(); 
            });
            document.getElementById('mobile-menu-btn').addEventListener('click', () => toggleSidebar(true));
            document.getElementById('sidebar-close-btn').addEventListener('click', () => toggleSidebar(false));
            DOM.overlay.addEventListener('click', () => toggleSidebar(false));
            
            const urlParams = new URLSearchParams(window.location.search);
            const site = urlParams.get('site');
            if (site) {
                const p = `${App.config.jsonPrefix}${site}.json`;
                loadData(p);
                setTimeout(() => {
                    const existing = DOM.sourceList.querySelector(`[data-value="${p}"]`);
                    if (!existing) {
                        const div = document.createElement('div');
                        div.className = 'bg-dark-bg border border-dark-border text-dark-text py-1.5 px-2 rounded text-xs cursor-pointer hover:bg-dark-hover transition-colors';
                        div.textContent = site;
                        div.dataset.value = p;
                        DOM.sourceList.appendChild(div);
                    }
                }, 500);
            }
        });
    </script>
</body>
</html>